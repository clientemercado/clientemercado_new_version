@model  ClienteMercado.Models.AcompanharCotacaoEnviada

@{
    ViewBag.Title = "ClienteMercado";
    Layout = "~/Views/Shared/_Layout_internas2.cshtml";
}

<!-- OBS.: ALTERAR OS DADOS ABAIXO, ADEQUANDO-OS AOS DO USUÁRIO EMPRESA -->
<div id="tools-bar">
    <div class="container-fluid">
        <div class="caixa-botoes pull-left" id="caixa-botoes">
            <a tabindex="-1" href="#" class="btn">&nbsp;</a>
        </div>

        <div class="breadcrumb pull-left">
            <p><span style="color: blue;font-weight: bold;font-size: 8pt;"><a href="@Url.Action("PerfilUsuarioEmpresa", "UsuarioEmpresa", new { nmU = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(@ViewBag.nomeUsuarioLogado), nmE = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(@ViewBag.nomeEmpresaLogado), cloG = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(Convert.ToString(@ViewBag.idLogradouro)), cbaiR = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(Convert.ToString(@ViewBag.idBairro)), cciD = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(Convert.ToString(@ViewBag.idCidade)), cesT = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(Convert.ToString(@ViewBag.idEstado)), ccouT = ClienteMercado.Utils.Utilitarios.MD5Crypt.Criptografar(Convert.ToString(@ViewBag.idPais)) })" style="font-size: 9pt;">@ViewBag.deOndeVim</a></span> > <span font-weight bold;font-size 8pt;>@ViewBag.ondeEstou</span></p>
        </div>
    </div>
</div> 
<!-- FIM DA BARRA DE FERRAMENTAS -->

<!-- Menu Lateral -->
<div id="sidebar-wrapper">
    <div class="corpo-menu">
        <div class="divider"></div>
        <ul id="menu-content" class="menu-content">

            <li data-toggle="collapse" data-target="#cotacao_enviada" class="collapsed">
                <a href="#"><i class="fa fa-list-ul"></i> Relatórios <i class="fa fa-angle-right pull-right"></i></a>
            </li>
            <ul class="sub-menu collapse" id="cotacao_enviada">
                <li><a href="#">Relatório 1</a></li>
                <li><a href="#">Relatório 2</a></li>
                <li><a href="#">Relatório 3</a></li>
                <li><a href="#">Relatório 4</a></li>
            </ul>
            <li class="separador"></li>
            <li data-toggle="collapse" data-target="#configuracoes" class="collapsed">
                <a href="#"><i class="fa fa-gear"></i> Configurações <i class="fa fa-angle-right pull-right"></i></a>
            </li>
            <ul class="sub-menu collapse" id="configuracoes">
                <li><a href="#">Dados da Empresa</a></li>
                <li><a href="#">Dados Usuário Master</a></li>
                <li><a href="#">Outros Usuários da Empresa</a></li>
                <li><a href="#">Liberação de Cadastro</a></li>
            </ul>

        </ul>
        <div id="logo-clientemercado">
            <img src="@Url.Content("~/Content/images/logo_branca.png")" alt="">
            <p>2015 &copy; Todos os direitos reservados.</p>
        </div>
    </div>
</div>
<!-- /#sidebar-wrapper -->

<!-- Conteudo -->
<div id="page-content-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">

                <div class="col-md-12" id="tabela1">
                    <table class="table table-striped table-ordered table-bordered col-md-4">
                        <tr>
                            <td style="border:0px;">
                                <label for="">Cotação:</label>
                                @Html.TextBoxFor(m => m.NOME_COTACAO_ENVIADA, new { @class = "form-control", @id = "NOME_COTACAO_ENVIADA", @style = "width:300px; font-weight: bold" })
                            </td>
                            <td style="border:0px;  margin-top:23px;">
                                <label for="">Status:</label>
                                @if ((Model.STATUS_COTACAO_ENVIADA == "ABERTA") || (Model.STATUS_COTACAO_ENVIADA == "EM ANDAMENTO"))
                                {
                                    @Html.TextBoxFor(m => m.STATUS_COTACAO_ENVIADA, new { @class = "form-control", @id = "STATUS_COTACAO_ENVIADA", @style = "width:150px; color: #FF0000; font-weight: bold" })
                                }
                                else
                                {
                                    @Html.TextBoxFor(m => m.STATUS_COTACAO_ENVIADA, new { @class = "form-control", @id = "STATUS_COTACAO_ENVIADA", @style = "width:150px; color: #0101DF; font-weight: bold" })
                                }
                            </td>
                            <td style="border:0px;">
                                <label for="">Categoria:</label>
                                @Html.TextBoxFor(m => m.CATEGORIA_COTACAO_ENVIADA, new { @class = "form-control", @id = "STATUS_COTACAO_ENVIADA", @style = "width:300px; font-weight: bold" })
                            </td>
                            <td style="border:0px; margin-top:23px;">
                                <label for="">% Respondida: </label>
                                @if (Convert.ToDouble(Model.PERCENTUAL_RESPONDIDA_COTACAO_ENVIADA) < Convert.ToDouble(50.01))
                                {
                                    @Html.TextBoxFor(m => m.PERCENTUAL_RESPONDIDA_COTACAO_ENVIADA, new { @class = "form-control", @id = "PERCENTUAL_RESPONDIDA_COTACAO_ENVIADA", @style = "width:100px; color: #FF0000; font-weight: bold" })
                                }
                                else
                                {
                                    @Html.TextBoxFor(m => m.PERCENTUAL_RESPONDIDA_COTACAO_ENVIADA, new { @class = "form-control", @id = "PERCENTUAL_RESPONDIDA_COTACAO_ENVIADA", @style = "width:100px; color: #0101DF; font-weight: bold" })
                                }
                            </td>
                        </tr>
                    </table>

                    <div role="tabpanel" class="" id="listaItensCotacao">
                        <table id="lista_itens_cotacao" class="table table-striped table-ordered table-bordered col-md-4">
                            <thead>
                                <tr style="background-color: #e8e8e8;">
                                    <th align="center" colspan="4">
                                        <i class="fa fa-shopping-cart"></i> <strong>PRODUTOS COTADOS: </strong>
                                    </th>
                                    <th align="center" colspan="3">
                                        <i class="fa fa-calculator"></i> <strong>ANÁLISE GERAL: </strong>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0101DF"><a href="#" style="text-decoration:none"><i class="fa fa-search"></i> Ver Análise</a></font>
                                    </th>
                                </tr>
                            </thead>

                            <!-- Exibe o Grid com a lista dos PRODUTOS cotados -->
                            @{
                                Html.RenderPartial("GridItensEnviadosParaCotacao");
                            }
                        </table>
                        <br />
                    </div>

                    <div role="tabpanel" class="" id="listaDeFornecedoresCotados">
                        <table id="lista_fornecedores_cotacao" class="table table-striped table-ordered table-bordered col-md-4">
                            <thead>
                                <tr style="background-color: #e8e8e8;">
                                    <th align="center" colspan="7">
                                        <i class="fa fa-pencil-square"></i> <strong>FORNECEDORES RESPONDENDO: </strong>
                                    </th>
                                </tr>
                            </thead>

                            <!-- Exibe o Grid com a lista dos FORNECEDORES cotados -->
                            @{
                                Html.RenderPartial("GridFornecedoresCotados");
                            }
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        $(document).ready(function () {
            //Desabilitar botão direito do mouse
            $(document).bind("contextmenu", function (e) {
                //return false;
            });

            //Desabilitando os campos de identificação da COTAÇÃO
            $('#NOME_COTACAO_USUARIO_COTANTE').attr('readonly', true);
            $('#CATEGORIA_COTACAO').attr('readonly', true);
            $('#TIPO_COTACAO').attr('readonly', true);
            $('#PERCENTUAL_RESPONDIDA_COTACAO_USUARIO_COTANTE').attr('readonly', true);
            $('#STATUS_COTACAO').attr('readonly', true);
            $('#DATA_CRIACAO_COTACAO_USUARIO_COTANTE').attr('readonly', true);
            $('#DATA_ENCERRAMENTO_COTACAO_USUARIO_COTANTE').attr('readonly', true);

            $("#linkSair").attr('tabindex', '-1');

            //Armazena o ID da EMPRESA FORNECEDORA e EXIBE RESPOSTAS das PERGUNTAS
            $(".verResposta").click(function () {
                var idCotacaoFilha = "#inIdCotacaoFilha_" + $(this).attr('id');
                var temFotosDeProdutosAlternativos = "";

                $('#ID_FORNECEDOR_COTACAO_ANALISADA').val($(this).attr('id'));

                $("#texto_chat_principal").hide();
                $('#dialogo_entre_cotante_efornecedor td').parent().remove(); //Limpar / Remover linha

                //Carregar resultado cotado com o FORNECEDOR
                $.ajax({
                    type: "POST",
                    url: "/UsuarioEmpresa/CarregarRespostaDaCotacao",
                    dataType: "json",
                    data: {
                        'idCotacaoFilha': $(idCotacaoFilha).val(),
                        'tipoCotacao': "ec"
                    },
                    success: function (data) {
                        //LIMPA as linhas da TABLE, preparando para uma nova montagem
                        $('#resposta_do_fornecedor td').parent().remove();

                        $.each(data, function (index, resposta) {
                            debugger;

                            if (parseInt(resposta.quantidade_imagens_anexadas) > 0)
                            {
                                temFotosDeProdutosAlternativos = "ver produto similar";
                            }

                            $('<tr>' +
                                '<td width="40%" align="left">&nbsp;' + resposta.nome_produto + '</td>' +
                                '<td width="10%" align="right">&nbsp;' + resposta.quantidade_produto_exibicao + '</td>' +
                                '<td width="10%" align="right">&nbsp;' + resposta.valor_produto + '</td>' +
                                '<td width="10%" align="right">&nbsp;' + resposta.total_por_produto + '</td>' +
                                '<td width="10%" align="center">&nbsp;</td>' +
                                '<td width="20%" align="center">&nbsp;<a href="#" id="" class="similares" data-toggle="modal" data-target="#modal_produtos_alternativos" onClick="ver_alternativos(' + resposta.id_codigo_cotacao_filha_negociacao + ',' + $(idCotacaoFilha).val() + ')">' + temFotosDeProdutosAlternativos + '</a></td>' +
                                '</tr>').appendTo('#resposta_do_fornecedor');

                            temFotosDeProdutosAlternativos = "";
                        });
                    }
                });

                //Carregar DIÁLOGO do COTANTE com o FORNECEDOR
                $.ajax({
                    type: "POST",
                    url: "/UsuarioEmpresa/CarregarDialogoEntreCotanteEFornecedor",
                    dataType: "json",
                    data: {
                        'idCotacaoFilha': $(idCotacaoFilha).val(),
                        'tipoCotacao': "ec"
                    },
                    success: function (data) {
                        var quantosDialogos = data.length;
                        var contadorMsg = 1;

                        if (quantosDialogos > 0) {
                            $.each(data, function (index, chat) {

                                //Inserir no Grid
                                if (contadorMsg & 1) {
                                    $('<table><tr><td width="2%"></td><td width="90%"><font color="#337ab7"><i class="fa fa-comment fa-2x"></i> </font><font color="#000000">' + chat.texto_chat + '</font></td></tr></table>').appendTo('#dialogo_entre_cotante_efornecedor');
                                } else {
                                    $('<table><tr style="border-style: dotted; border-bottom-width: 1px; border-top-width: 0; border-right-width: 0; border-left-width: 0; border-bottom-color: #C0C0C0;"><td><font color="#FFFFFF">vazio</font></td><td></td><td width="100%"><font color=""><i class="fa fa-comments fa-2x"></i> </font><font color="#000000">' + chat.texto_chat + '<font color="#A9A9A9"> - ' + chat.data_chat + '</font></font></td></tr></table>').appendTo('#dialogo_entre_cotante_efornecedor');
                                }

                                contadorMsg = (parseInt(contadorMsg) + parseInt(1));
                            });

                            //Controla todo o processo de CHAT
                            if (quantosDialogos & 1) {
                                //Habilita campo para PERGUNTA / RESPOSTA
                                $("#texto_chat_alternativo").hide();
                            }
                            else {
                                //Desabilita campo para PERGUNTA / RESPOSTA
                                $("#texto_chat_alternativo").show();
                            }
                        }
                        else {
                            //Habilita campo para PERGUNTA / RESPOSTA
                            $("#texto_chat_alternativo").show();
                        }
                    }
                });
            });

            //Desabilita / Habilita o campo para digitação do texto de PERGUNTA / RESPOSTA
            $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE_ALTERNATIVO").focus(function () {
                $("#texto_chat_alternativo").hide();
                $("#texto_chat_principal").show();
                $("#botao_enviar").show();

                $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val('');
                $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").focus();
            });

            $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").focus(function () {
                $("#botao_enviar").show();
            });

            //Registra a PERGUNTA ou RESPOSTA, enviando-a ao FORNECEDOR COTADO
            $("#enviarPerguntaOuResposta").click(function () {
                if ($("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val() != '') {

                    debugger;
                    idFornecedor = $('#ID_FORNECEDOR_COTACAO_ANALISADA').val();
                    idCotacaoFilha = "#inIdCotacaoFilha_" + idFornecedor;
                    textoPerguntaOuResposta = $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val();

                    $.ajax({
                        url: "/UsuarioEmpresa/EnviarComunicacaoAoFornecedorNaCotacao",
                        dataType: 'json',
                        cache: false,
                        async: true,
                        data: {
                            'idCotacaoFilha': $(idCotacaoFilha).val(), 'idEmpresaCotada': idFornecedor, 'textoPerguntaOuResposta': textoPerguntaOuResposta
                        },
                        success: function (data) {
                            //debugger;
                            $("#texto_chat_principal").val('');
                            $("#texto_chat_principal").hide();
                            $("#texto_chat_alternativo").hide();
                            $("#botao_enviar").hide();
                            $('#dialogo_entre_cotante_efornecedor td').parent().remove(); //Limpar / Remover linha

                            //Carregar DIÁLOGO do COTANTE com o FORNECEDOR
                            $.ajax({
                                type: "POST",
                                url: "/UsuarioEmpresa/CarregarDialogoEntreCotanteEFornecedor",
                                dataType: "json",
                                data: {
                                    'idCotacaoFilha': $(idCotacaoFilha).val(),
                                    'tipoCotacao': "ec"
                                },
                                success: function (data) {
                                    var quantosDialogos = data.length;
                                    var contadorMsg = 1;

                                    if (quantosDialogos > 0) {
                                        $.each(data, function (index, chat) {

                                            //Inserir no Grid
                                            if (contadorMsg & 1) {
                                                $('<table><tr><td width="2%"></td><td width="90%"><font color="#337ab7"><i class="fa fa-comment fa-2x"></i> </font><font color="#000000">' + chat.texto_chat + '</font></td></tr></table>').appendTo('#dialogo_entre_cotante_efornecedor');

                                                //Muda STATUS do CHAT (informa que não há novas mensagens)
                                                $("#bonecoChat_" + idFornecedor).css({ "color": "#23527c" });
                                            } else {
                                                $('<table><tr style="border-style: dotted; border-bottom-width: 1px; border-top-width: 0; border-right-width: 0; border-left-width: 0; border-bottom-color: #C0C0C0;"><td><font color="#FFFFFF">vazio</font></td><td></td><td width="100%"><font color=""><i class="fa fa-comments fa-2x"></i> </font><font color="#000000">' + chat.texto_chat + '<font color="#A9A9A9"> - ' + chat.data_chat + '</font></font></td></tr></table>').appendTo('#dialogo_entre_cotante_efornecedor');

                                                //Muda STATUS do CHAT (informa que há novas mensagens)
                                                $("#bonecoChat_" + idFornecedor).css({ "color": "#FF0000" });
                                            }

                                            contadorMsg = (parseInt(contadorMsg) + parseInt(1));
                                        });

                                        //Controla todo o processo de CHAT
                                        if (quantosDialogos & 1) {
                                            //Habilita campo para PERGUNTA / RESPOSTA
                                            $("#texto_chat_alternativo").hide();
                                        }
                                        else {
                                            //Desabilita campo para PERGUNTA / RESPOSTA
                                            $("#texto_chat_alternativo").show();
                                        }
                                    }
                                    else {
                                        //Habilita campo para PERGUNTA / RESPOSTA
                                        $("#texto_chat_alternativo").show();
                                    }
                                }
                            });

                        }
                    });
                }
                else {
                    alert("ATENÇÃO!!\n\nDigite a PERGUNTA ou RESPOSTA a ser encaminhada ao vendedor!");

                    $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val('');
                    $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").focus();
                }
            });

            //Contador REGRESSIVO de caracteres do campo TEXTAREA
            $(document).on("input", "#TEXTO_CHAT_COTACAO_USUARIO_COTANTE", function () {
                var limite = 200;
                var informativo = " caracteres restantes";
                var caracteresDigitados = $(this).val().length;
                var caracteresRestantes = (limite - caracteresDigitados);

                if (caracteresRestantes <= 0) {
                    var comentario = $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val();
                    $("#TEXTO_CHAT_COTACAO_USUARIO_COTANTE").val(comentario.substr(0, limite));
                    $(".caracteres").text("0 " + informativo);
                } else {
                    $(".caracteres").text(caracteresRestantes + " " + informativo);
                }
            });

            //HABILITA / DESABILITA campos do CHAT
            $(".habiliteCampo").click(function () {
                $("#texto_chat_principal").val('');
                $("#texto_chat_principal").hide();
                $("#botao_enviar").hide();

                $('#ID_FORNECEDOR_COTACAO_ANALISADA').val('');
            });

        });

        //EXIBIR as fotos de produtos alternativos anexados à cotação
        function ver_alternativos(idCotacaoFilhaNegociacao, idCotacaoFilha) {
            debugger;
            var linkImagem = "";

            $.ajax({
                type: "POST",
                url: "/UsuarioEmpresa/CarregarFotosDosProdutosAlternativos",
                dataType: "json",
                data: {
                    'idCotacaoFilhaNegociacao': idCotacaoFilhaNegociacao,
                    'idCotacaoFilha': idCotacaoFilha,
                    'tipoCotacao': "ec"
                },
                success: function (data) {
                    //LIMPA as linhas da TABLE, preparando para uma nova montagem
                    $("#bullets_produtos").empty();
                    $("#imagens_produtos_alternativos").empty();

                    debugger;

                    if (parseInt(data.quantidade_imagens_anexadas) > 0)
                    {
                        var listaDeFotos = data.fotos_produtos_alternativos.split(",");
                        var conteudoBullets = "";
                        var conteudoListaFotos = "<div class='item active'>";

                        //MONTAR HTML para exibição de FOTOS no SLIDER
                        for (var b = 0; b < listaDeFotos.length; b++) {
                            //MONTANDO LISTA de FOTOS
                            linkImagem = '@Url.Content("~/Content/imagensProdutosAlternativos/")' + listaDeFotos[b];

                            if (conteudoListaFotos == "<div class='item active'>") {
                                conteudoListaFotos = (conteudoListaFotos + '<img src="' + linkImagem + '" ></div>');
                            }
                            else {
                                conteudoListaFotos = (conteudoListaFotos + '<div class="item"><img src="' + linkImagem + '" ></div>');
                            }

                            //MONTANDO os BULLETS (Navegadores)
                            if (b == 0){
                                conteudoBullets = "<li data-target='#meuSlider' data-slide-to='0' class='active'></li>";
                            }
                            else {
                                conteudoBullets = (conteudoBullets + '<li data-target="#meuSlider" data-slide-to="' + b +'"></li>');
                            }
                        }

                        $("#bullets_produtos").append(conteudoBullets);
                        $("#imagens_produtos_alternativos").append(conteudoListaFotos);
                    }
                }
            });
        }

        //CARREGAR determinado ITEM com os preços fornecidos por TODOS os FORNECEDORES que receberam a COTAÇÂO
        function CarregarItensCotadosPorFornecedor(idCotacaoMaster, idCodigoProduto) {
            debugger;

            //=======================================================================
            //Carregar resultado cotado com o FORNECEDOR
            $.ajax({
                type: "POST",
                url: "/UsuarioEmpresa/CarregarRespostaDaCotacaoPorProduto",
                dataType: "json",
                data: {
                    'idCotacaoMaster': idCotacaoMaster,
                    'idCodigoProduto': idCodigoProduto,
                    'tipoCotacao': "ec"
                },
                success: function (data) {
                    debugger;

                    //LIMPA as linhas da TABLE, preparando para uma nova montagem
                    $('#resposta_do_fornecedor_por_produto td').parent().remove();

                    $.each(data, function (index, resposta) {
                        debugger

                        //if (parseInt(resposta.quantidade_imagens_anexadas) > 0) {
                        //    temFotosDeProdutosAlternativos = "ver similar";
                        //}

                        if (resposta.menor_valor == "sim") {
                            $('<tr>' +
                                '<td width="25%" align="left">&nbsp;<font color=red><b>' + resposta.nome_produto + '</font></b></td>' +
                                '<td width="10%" align="right"><font color=red><b>' + resposta.quantidade_produto_exibicao + '&nbsp;</font></b></td>' +
                                '<td width="10%" align="right"><font color=red><b>' + resposta.valor_produto + '&nbsp;</font></b></td>' +
                                '<td width="10%" align="right"><font color=red><b>' + resposta.total_por_produto + '&nbsp;</font></b></td>' +
                                '<td width="5%" align="center"><font color=red><b>' + resposta.percentual_desconto + '%&nbsp;</font></b></td>' +
                                '<td width="10%" align="right"><font color=red><b>' + resposta.total_por_produto_com_desconto + '&nbsp;</font></b></td>' +
                                '<td width="20%" align="right"><font color=red><b>' + resposta.empresa_cotada + '</font></b></td>' +
                                '<td width="10%" align="center"><a href="#" title="Menor Preço"><font color=green><i class="fa fa-check"></i></font></a></td>' +
                                '</tr>').appendTo('#resposta_do_fornecedor_por_produto');
                        }
                        else {
                            $('<tr>' +
                                '<td width="25%" align="left">&nbsp;' + resposta.nome_produto + '</td>' +
                                '<td width="10%" align="right">' + resposta.quantidade_produto_exibicao + '&nbsp;</td>' +
                                '<td width="10%" align="right">' + resposta.valor_produto + '&nbsp;</td>' +
                                '<td width="10%" align="right">' + resposta.total_por_produto + '&nbsp;</td>' +
                                '<td width="5%" align="center"><b>' + resposta.percentual_desconto + '%&nbsp;</b></td>' +
                                '<td width="10%" align="right">' + resposta.total_por_produto_com_desconto + '&nbsp;</td>' +
                                '<td width="20%" align="right">' + resposta.empresa_cotada + '</td>' +
                                '<td width="10%" align="center">&nbsp;</td>' +
                                '</tr>').appendTo('#resposta_do_fornecedor_por_produto');
                        }

                        temFotosDeProdutosAlternativos = "";
                    });
                }
            });
            //=======================================================================
        }

    </script>
}
